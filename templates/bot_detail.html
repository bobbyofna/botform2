<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Detail - BotForm2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Jura', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Sticky Header -->
    <nav class="sticky top-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm border-b border-gray-800">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Left: Back button and Bot Name -->
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-blue-400 hover:text-blue-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div>
                        <h1 id="headerBotName" class="text-lg font-semibold text-white">Loading...</h1>
                        <p id="headerTargetUser" class="text-xs text-gray-400">Target: ...</p>
                    </div>
                </div>

                <!-- Center: Bot Stats -->
                <div class="hidden md:flex items-center space-x-6 text-sm">
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Status</div>
                        <div id="headerStatus" class="font-semibold text-white">Inactive</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Total P/L</div>
                        <div id="headerBotPL" class="font-semibold text-green-400">$0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Total Trades</div>
                        <div id="headerTotalTrades" class="font-semibold text-blue-400">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Win Rate</div>
                        <div id="headerBotWinRate" class="font-semibold text-purple-400">0%</div>
                    </div>
                </div>

                <!-- Right: User Menu -->
                <div class="flex items-center space-x-4">
                    <button id="hamburgerBtn" class="text-white hover:text-blue-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hamburger Menu (Hidden by default) -->
    <div id="hamburgerMenu" class="hidden fixed top-16 right-0 z-40 w-64 bg-black bg-opacity-90 border-l border-gray-800 shadow-xl">
        <div class="p-4 space-y-2">
            <a href="/" class="block px-4 py-2 text-white hover:bg-gray-700 rounded">Dashboard</a>
            {% if is_admin %}
            <a href="/settings" class="block px-4 py-2 text-white hover:bg-gray-700 rounded">Settings</a>
            {% endif %}
            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-red-400 hover:bg-gray-700 rounded">Logout</button>
        </div>
    </div>

    <!-- Video Background -->
    <div class="video-background">
        <video autoplay loop muted playsinline id="bgVideo">
            <source src="/bg.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Page Container -->
    <div class="page-container">
    <div class="container mx-auto px-4 py-8">
        <!-- Top Bar with All Controls -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button onclick="window.location.href='/'" class="back-btn">
                    ←
                </button>
                <h1 id="botName" class="text-2xl font-bold text-white">Loading...</h1>
                <span id="statusBadge" class="badge badge-inactive">Loading</span>
            </div>
            <div class="top-bar-right">
                <div class="bot-controls">
                    {% if is_admin %}
                    <button id="stopBtn" class="control-btn" data-mode="inactive">
                        Stop
                    </button>
                    <button id="startPaperBtn" class="control-btn" data-mode="paper">
                        Paper
                    </button>
                    <button id="startProdBtn" class="control-btn" data-mode="production">
                        Production
                    </button>
                    {% else %}
                    <button disabled class="control-btn opacity-50 cursor-not-allowed" title="Admin only">
                        Stop
                    </button>
                    <button disabled class="control-btn opacity-50 cursor-not-allowed" title="Admin only">
                        Paper
                    </button>
                    <button disabled class="control-btn opacity-50 cursor-not-allowed" title="Admin only">
                        Production
                    </button>
                    {% endif %}
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div id="healthCheck" class="text-sm text-gray"></div>
                    <div class="text-sm">
                        <span class="text-gray">P/L:</span>
                        <span id="topPL" class="font-semibold text-white">$0.00</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray">Trades:</span>
                        <span id="topTrades" class="font-semibold text-white">0</span>
                    </div>
                </div>
            </div>
        </div>

        <main>

            <!-- Performance Chart and Parameters Side-by-Side -->
            <div class="bot-detail-content mb-8">
                <!-- Bot Parameters (Left Side) -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">Bot Parameters</h2>
                    <div class="bot-params-vertical">
                        <div class="param-item">
                            <span class="param-label">Max Trade Value</span>
                            <span class="param-value" id="paramMaxTrade">$0</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Min Trade Value</span>
                            <span class="param-value" id="paramMinTrade">$0</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Copy Ratio</span>
                            <span class="param-value" id="paramCopyRatio">0.0</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Stop Loss</span>
                            <span class="param-value" id="paramStopLoss">0%</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Max Daily Loss</span>
                            <span class="param-value" id="paramMaxDaily">$0</span>
                        </div>
                        {% if is_admin %}
                        <button id="editParamsBtn" class="btn btn-primary w-full mt-4">
                            Edit Parameters
                        </button>
                        {% else %}
                        <button disabled class="btn btn-secondary w-full mt-4 opacity-50 cursor-not-allowed">
                            Edit Parameters (Admin Only)
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Performance Chart (Right Side - 2/3 width) -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Performance</h2>
                        <div class="flex gap-2">
                            <button class="period-btn px-3 py-1 rounded border border-gray-600 text-gray hover:bg-gray-700 transition" data-period="1h">1H</button>
                            <button class="period-btn px-3 py-1 rounded border border-gray-600 text-gray hover:bg-gray-700 transition" data-period="24h">24H</button>
                            <button class="period-btn px-3 py-1 rounded bg-blue-primary text-white" data-period="7d">7D</button>
                            <button class="period-btn px-3 py-1 rounded border border-gray-600 text-gray hover:bg-gray-700 transition" data-period="30d">30D</button>
                        </div>
                    </div>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Bot Recent Activity Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('botActivity')">
                    <h2 class="text-xl font-semibold text-white">Bot Recent Activity</h2>
                    <svg id="botActivityArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="botActivityPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading bot activity...</p>
                </div>
                <div id="botActivityExpanded" class="hidden">
                    <div id="botActivityList" class="space-y-2 mb-4">
                        <!-- Activity items will be loaded here -->
                    </div>
                    <div id="botActivityPagination" class="flex justify-between items-center">
                        <button onclick="changePage('botActivity', -1)" class="btn btn-secondary disabled:opacity-50" id="botActivityPrevBtn">
                            ← Previous
                        </button>
                        <span id="botActivityPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('botActivity', 1)" class="btn btn-secondary disabled:opacity-50" id="botActivityNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Open Bets Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('openBets')">
                    <h2 class="text-xl font-semibold text-white">Open Bets</h2>
                    <svg id="openBetsArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="openBetsPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading open bets...</p>
                </div>
                <div id="openBetsExpanded" class="hidden">
                    <div id="openBetsList" class="space-y-2 mb-4">
                        <!-- Open bet items will be loaded here -->
                    </div>
                    <div id="openBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('openBets', -1)" class="btn btn-secondary disabled:opacity-50" id="openBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="openBetsPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('openBets', 1)" class="btn btn-secondary disabled:opacity-50" id="openBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Closed Bets Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('closedBets')">
                    <h2 class="text-xl font-semibold text-white">Closed Bets</h2>
                    <svg id="closedBetsArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="closedBetsPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading closed bets...</p>
                </div>
                <div id="closedBetsExpanded" class="hidden">
                    <div id="closedBetsList" class="space-y-2 mb-4">
                        <!-- Closed bet items will be loaded here -->
                    </div>
                    <div id="closedBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('closedBets', -1)" class="btn btn-secondary disabled:opacity-50" id="closedBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="closedBetsPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('closedBets', 1)" class="btn btn-secondary disabled:opacity-50" id="closedBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Target User Recent Activity Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('targetUserActivity')">
                    <h2 class="text-xl font-semibold text-white">Target User Recent Activity</h2>
                    <svg id="targetUserActivityArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="targetUserActivityPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading target user activity...</p>
                </div>
                <div id="targetUserActivityExpanded" class="hidden">
                    <div id="targetUserActivityList" class="space-y-2 mb-4">
                        <!-- Target user activity items will be loaded here -->
                    </div>
                    <div id="targetUserActivityPagination" class="flex justify-between items-center">
                        <button onclick="changePage('targetUserActivity', -1)" class="btn btn-secondary disabled:opacity-50" id="targetUserActivityPrevBtn">
                            ← Previous
                        </button>
                        <span id="targetUserActivityPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('targetUserActivity', 1)" class="btn btn-secondary disabled:opacity-50" id="targetUserActivityNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Parameters Modal -->
            <div id="editParamsModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                <div class="modal-content p-8 max-w-2xl w-full">
                    <h2 class="text-2xl font-bold mb-4 text-white">Edit Bot Parameters</h2>
                    <form id="parametersForm" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white text-sm font-bold mb-2">
                                Max Trade Value ($)
                                <span class="text-gray font-normal text-xs ml-1" title="Maximum amount per trade">(?)</span>
                            </label>
                            <input type="number" id="maxTradeValue" class="w-full py-2 px-3" step="0.01">
                        </div>
                        <div>
                            <label class="block text-white text-sm font-bold mb-2">
                                Min Trade Value ($)
                                <span class="text-gray font-normal text-xs ml-1" title="Minimum amount per trade">(?)</span>
                            </label>
                            <input type="number" id="minTradeValue" class="w-full py-2 px-3" step="0.01">
                        </div>
                        <div>
                            <label class="block text-white text-sm font-bold mb-2">
                                Copy Ratio
                                <span class="text-gray font-normal text-xs ml-1" title="Percentage of target trade size (0.0-1.0)">(?)</span>
                            </label>
                            <input type="number" id="copyRatio" class="w-full py-2 px-3" step="0.01" min="0" max="1">
                        </div>
                        <div>
                            <label class="block text-white text-sm font-bold mb-2">
                                Stop Loss (%)
                                <span class="text-gray font-normal text-xs ml-1" title="Percentage loss to trigger exit">(?)</span>
                            </label>
                            <input type="number" id="stopLoss" class="w-full py-2 px-3" step="0.1">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-white text-sm font-bold mb-2">
                                Max Daily Loss ($)
                                <span class="text-gray font-normal text-xs ml-1" title="Maximum total loss per day">(?)</span>
                            </label>
                            <input type="number" id="maxDailyLoss" class="w-full py-2 px-3" step="0.01">
                        </div>
                        <div class="col-span-2 flex gap-2">
                            <button type="submit" class="btn btn-primary flex-1">
                                Update Parameters
                            </button>
                            <button type="button" id="cancelParamsBtn" class="btn btn-secondary flex-1">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-white">Notes</h2>
                {% if is_admin %}
                <textarea id="botNotes" class="w-full py-2 px-3" rows="5" placeholder="Add notes about this bot..."></textarea>
                <p class="text-sm text-gray mt-2">Auto-saves 2 seconds after you stop typing</p>
                {% else %}
                <textarea id="botNotes" class="w-full py-2 px-3" rows="5" placeholder="Add notes about this bot..." readonly disabled></textarea>
                <p class="text-sm text-yellow-500 mt-2">Guest users cannot edit notes (read-only)</p>
                {% endif %}
            </div>

            <!-- Danger Zone - Delete Bot -->
            <div class="card p-6 border-2 border-red-600">
                <h2 class="text-xl font-semibold mb-2 text-red">Danger Zone</h2>
                <p class="text-sm text-gray mb-4">Deleting this bot is permanent and cannot be undone. All trade history and configuration will be lost.</p>
                {% if is_admin %}
                <button id="deleteBotBtn" class="btn btn-danger">
                    Delete Bot
                </button>
                {% else %}
                <button disabled class="btn btn-secondary opacity-50 cursor-not-allowed">
                    Delete Bot (Admin Only)
                </button>
                {% endif %}
            </div>
        </main>
    </div>
    </div>

    <script>
        // Lazy load video background
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('bgVideo');
            if (video && video.getAttribute('src') === null) {
                const source = video.querySelector('source');
                if (source) {
                    video.load();
                }
            }
        });

        const botId = window.location.pathname.split('/').pop();
        let botData = null;
        let notesDebounceTimer = null;
        let currentPeriod = '7d';

        // Admin status from Jinja template
        const isAdmin = {{ is_admin|tojson }};

        // Hamburger menu toggle
        document.getElementById('hamburgerBtn').addEventListener('click', () => {
            const menu = document.getElementById('hamburgerMenu');
            menu.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('hamburgerMenu');
            const btn = document.getElementById('hamburgerBtn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Logout function
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => window.location.href = '/login');
        }

        // Update header stats
        function updateHeaderStats() {
            if (!botData) return;

            document.getElementById('headerBotName').textContent = botData.name || 'Bot';
            document.getElementById('headerTargetUser').textContent = 'Target: ' + (botData.target_user_url || 'N/A').substring(0, 20) + '...';
            document.getElementById('headerStatus').textContent = (botData.status || 'inactive').toUpperCase();

            const pl = botData.total_profit || 0;
            document.getElementById('headerBotPL').textContent = '$' + pl.toFixed(2);
            document.getElementById('headerBotPL').className = 'font-semibold ' + (pl >= 0 ? 'text-green-400' : 'text-red-400');

            document.getElementById('headerTotalTrades').textContent = botData.total_trades || 0;

            const winRate = botData.total_trades > 0 ? ((botData.winning_trades || 0) / botData.total_trades * 100) : 0;
            document.getElementById('headerBotWinRate').textContent = winRate.toFixed(1) + '%';
        }

        // Initialize performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Profit/Loss ($)',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgb(255, 255, 255)'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgb(156, 163, 175)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: 'rgb(156, 163, 175)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });

        // Load bot data
        async function loadBotData() {
            try {
                const response = await fetch('/api/bots/' + botId);
                if (response.ok === false) {
                    alert('Bot not found');
                    window.location.href = '/';
                    return;
                }

                botData = await response.json();

                // Update header
                document.getElementById('botName').textContent = botData.name;

                // Update status badge
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = botData.status.toUpperCase();
                statusBadge.className = 'badge badge-' + botData.status;

                // Update control buttons
                document.querySelectorAll('.control-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.mode === botData.status) {
                        btn.classList.add('active');
                    }
                });

                // Update top bar stats
                document.getElementById('topPL').textContent = '$' + ((botData.total_profit || 0).toFixed(2));
                document.getElementById('topPL').className = 'font-semibold ' + ((botData.total_profit || 0) >= 0 ? 'text-green' : 'text-red');
                document.getElementById('topTrades').textContent = botData.total_trades || 0;

                // Update parameter display
                document.getElementById('paramMaxTrade').textContent = '$' + (botData.max_trade_value || 0).toFixed(2);
                document.getElementById('paramMinTrade').textContent = '$' + (botData.min_trade_value || 0).toFixed(2);
                document.getElementById('paramCopyRatio').textContent = (botData.copy_ratio || 0).toFixed(2);
                document.getElementById('paramStopLoss').textContent = (botData.stop_loss_percentage || 0).toFixed(1) + '%';
                document.getElementById('paramMaxDaily').textContent = '$' + (botData.max_daily_loss || 0).toFixed(2);

                // Populate parameters form
                document.getElementById('maxTradeValue').value = botData.max_trade_value || 500;
                document.getElementById('minTradeValue').value = botData.min_trade_value || 50;
                document.getElementById('copyRatio').value = botData.copy_ratio || 0.5;
                document.getElementById('stopLoss').value = botData.stop_loss_percentage || 10;
                document.getElementById('maxDailyLoss').value = botData.max_daily_loss || 1000;

                // Populate notes
                document.getElementById('botNotes').value = botData.notes || '';

                // Update header stats
                updateHeaderStats();

                // Load health check
                await checkTargetUserHealth();

                // Load section data
                await loadSectionData();

                // Load performance data
                await loadPerformanceData();

            } catch (error) {
                console.error('Error loading bot:', error);
                alert('Error loading bot data');
            }
        }

        // Check target user health
        async function checkTargetUserHealth() {
            const healthDiv = document.getElementById('healthCheck');
            healthDiv.innerHTML = '<span class="text-gray">Checking...</span>';

            try {
                const response = await fetch('/api/validate-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_user_url: botData.target_user_url})
                });

                const result = await response.json();

                if (result.valid === true) {
                    healthDiv.innerHTML = '<span class="text-green">✓ Active</span>';
                } else {
                    healthDiv.innerHTML = '<span class="text-red">✗ ' + result.message + '</span>';
                }
            } catch (error) {
                healthDiv.innerHTML = '<span class="text-red">✗ Error</span>';
            }
        }

        // Edit parameters modal
        const editParamsBtn = document.getElementById('editParamsBtn');
        if (editParamsBtn) {
            editParamsBtn.addEventListener('click', () => {
                if (!isAdmin) {
                    alert('Guest users cannot edit bot parameters.');
                    return;
                }
                document.getElementById('editParamsModal').classList.remove('hidden');
            });
        }

        document.getElementById('cancelParamsBtn').addEventListener('click', () => {
            document.getElementById('editParamsModal').classList.add('hidden');
        });

        // Extract user address from URL or direct input
        function extractUserAddress(targetUserUrl) {
            if (!targetUserUrl) return null;

            // Check if it's already a direct address (0x...)
            const directMatch = targetUserUrl.match(/^(0x[a-fA-F0-9]{40})$/);
            if (directMatch) {
                return directMatch[1];
            }

            // Try to extract from URL format
            const urlMatch = targetUserUrl.match(/\/user\/(0x[a-fA-F0-9]{40})/);
            if (urlMatch) {
                return urlMatch[1];
            }

            return null;
        }

        // Load performance data
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/bots/' + botId + '/performance?period=' + currentPeriod);
                const data = await response.json();

                if (data.data.length === 0) {
                    performanceChart.data.labels = [];
                    performanceChart.data.datasets[0].data = [];
                } else {
                    performanceChart.data.labels = data.data.map(d => new Date(d.timestamp).toLocaleString());
                    performanceChart.data.datasets[0].data = data.data.map(d => d.total_profit);
                }

                performanceChart.update();
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }

        // Period selectors
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => {
                    b.classList.remove('bg-blue-primary', 'text-white', 'border-blue-primary');
                    b.classList.add('border-gray-600', 'text-gray');
                });
                this.classList.remove('border-gray-600', 'text-gray');
                this.classList.add('bg-blue-primary', 'text-white');
                currentPeriod = this.dataset.period;
                loadPerformanceData();
            });
        });

        // Control buttons
        const stopBtn = document.getElementById('stopBtn');
        if (stopBtn) {
            stopBtn.addEventListener('click', async () => {
                if (!isAdmin) {
                    alert('Guest users cannot control bots.');
                    return;
                }
                try {
                    const response = await fetch('/api/bots/' + botId + '/stop', {method: 'POST'});
                    if (response.ok === true) {
                        alert('Bot stopped');
                        loadBotData();
                    }
                } catch (error) {
                    alert('Error stopping bot');
                }
            });
        }

        const startPaperBtn = document.getElementById('startPaperBtn');
        if (startPaperBtn) {
            startPaperBtn.addEventListener('click', async () => {
                if (!isAdmin) {
                    alert('Guest users cannot control bots.');
                    return;
                }
                try {
                    const response = await fetch('/api/bots/' + botId + '/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({mode: 'paper'})
                    });
                    if (response.ok === true) {
                        alert('Bot started in paper mode');
                        loadBotData();
                    }
                } catch (error) {
                    alert('Error starting bot');
                }
            });
        }

        const startProdBtn = document.getElementById('startProdBtn');
        if (startProdBtn) {
            startProdBtn.addEventListener('click', async () => {
                if (!isAdmin) {
                    alert('Guest users cannot control bots.');
                    return;
                }
                if (confirm('Are you sure you want to start in PRODUCTION mode? This will use real money.') === false) {
                    return;
                }

                try {
                    const response = await fetch('/api/bots/' + botId + '/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({mode: 'production'})
                    });
                    if (response.ok === true) {
                        alert('Bot started in production mode');
                        loadBotData();
                    }
                } catch (error) {
                    alert('Error starting bot');
                }
            });
        }

        // Update parameters
        document.getElementById('parametersForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAdmin) {
                alert('Guest users cannot update bot parameters.');
                return;
            }

            const updateData = {
                max_trade_value: parseFloat(document.getElementById('maxTradeValue').value),
                min_trade_value: parseFloat(document.getElementById('minTradeValue').value),
                copy_ratio: parseFloat(document.getElementById('copyRatio').value),
                stop_loss_percentage: parseFloat(document.getElementById('stopLoss').value),
                max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value)
            };

            try {
                const response = await fetch('/api/bots/' + botId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updateData)
                });

                if (response.ok === true) {
                    document.getElementById('editParamsModal').classList.add('hidden');
                    alert('Parameters updated successfully');
                    loadBotData();
                } else {
                    alert('Failed to update parameters');
                }
            } catch (error) {
                alert('Error updating parameters');
            }
        });

        // Auto-save notes with debounce
        document.getElementById('botNotes').addEventListener('input', () => {
            if (!isAdmin) {
                return; // Silently ignore for guest users (textarea should be disabled anyway)
            }

            if (notesDebounceTimer !== null) {
                clearTimeout(notesDebounceTimer);
            }

            notesDebounceTimer = setTimeout(async () => {
                const notes = document.getElementById('botNotes').value;

                try {
                    await fetch('/api/bots/' + botId + '/notes', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({notes: notes})
                    });
                } catch (error) {
                    console.error('Error saving notes:', error);
                }
            }, 2000);
        });

        // Delete bot handler
        const deleteBotBtn = document.getElementById('deleteBotBtn');
        if (deleteBotBtn) {
            deleteBotBtn.addEventListener('click', async () => {
                if (!isAdmin) {
                    alert('Guest users cannot delete bots.');
                    return;
                }

                const botName = botData ? botData.name : 'this bot';
                const confirmMessage = 'Are you sure you want to delete "' + botName + '"?\n\nThis action cannot be undone. All trade history and configuration will be permanently lost.';

                if (confirm(confirmMessage) === false) {
                    return;
                }

            // Double confirmation for extra safety
            if (confirm('This is your last chance. Really delete "' + botName + '"?') === false) {
                return;
            }

            try {
                const response = await fetch('/api/bots/' + botId, {
                    method: 'DELETE'
                });

                if (response.ok === true) {
                    alert('Bot deleted successfully');
                    window.location.href = '/';
                } else {
                    const errorData = await response.json();
                    alert('Failed to delete bot: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting bot: ' + error.message);
            }
            });
        }

        // Section state management
        const sectionStates = {
            botActivity: { expanded: false, page: 1, data: [] },
            targetUserActivity: { expanded: false, page: 1, data: [] },
            openBets: { expanded: false, page: 1, data: [] },
            closedBets: { expanded: false, page: 1, data: [] }
        };

        const PREVIEW_ITEMS = 3;
        const ITEMS_PER_PAGE = 20;

        // Load section state from localStorage
        function loadSectionStates() {
            try {
                const saved = localStorage.getItem('botDetailSectionStates_' + botId);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.keys(sectionStates).forEach(key => {
                        if (parsed[key]) {
                            sectionStates[key].expanded = parsed[key].expanded || false;
                            sectionStates[key].page = parsed[key].page || 1;
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading section states:', e);
            }
        }

        // Save section states to localStorage
        function saveSectionStates() {
            try {
                const toSave = {};
                Object.keys(sectionStates).forEach(key => {
                    toSave[key] = {
                        expanded: sectionStates[key].expanded,
                        page: sectionStates[key].page
                    };
                });
                localStorage.setItem('botDetailSectionStates_' + botId, JSON.stringify(toSave));
            } catch (e) {
                console.error('Error saving section states:', e);
            }
        }

        // Toggle section expand/collapse
        function toggleSection(sectionName) {
            const state = sectionStates[sectionName];
            state.expanded = !state.expanded;

            const previewEl = document.getElementById(sectionName + 'Preview');
            const expandedEl = document.getElementById(sectionName + 'Expanded');
            const arrowEl = document.getElementById(sectionName + 'Arrow');

            if (state.expanded) {
                previewEl.classList.add('hidden');
                expandedEl.classList.remove('hidden');
                arrowEl.classList.add('rotate-180');
                renderSection(sectionName, false);
            } else {
                previewEl.classList.remove('hidden');
                expandedEl.classList.add('hidden');
                arrowEl.classList.remove('rotate-180');
                renderSection(sectionName, true);
            }

            saveSectionStates();
        }

        // Change page for a section
        function changePage(sectionName, direction) {
            const state = sectionStates[sectionName];
            const newPage = state.page + direction;
            const totalPages = Math.ceil(state.data.length / ITEMS_PER_PAGE);

            if (newPage < 1 || newPage > totalPages) return;

            state.page = newPage;
            renderSection(sectionName, false);
            saveSectionStates();
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);

            if (days > 0) return days + 'd ago';
            if (hours > 0) return hours + 'h ago';
            const minutes = Math.floor(diff / (1000 * 60));
            if (minutes > 0) return minutes + 'm ago';
            return 'Just now';
        }

        // Render bot trade item
        function renderBotTradeItem(trade) {
            const profitLoss = trade.profit_loss || 0;
            const isProfitable = profitLoss >= 0;
            const colorClass = isProfitable ? 'text-green' : 'text-red';

            return `
                <div class="bot-list-item">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-${trade.is_paper_trade ? 'paper' : 'production'}">
                                    ${trade.is_paper_trade ? 'Paper' : 'Production'}
                                </span>
                                ${trade.status === 'open' ? '<span class="badge badge-open">Open</span>' : ''}
                                ${trade.status === 'closed' ? '<span class="badge badge-closed">Closed</span>' : ''}
                            </div>
                            <p class="text-sm text-gray mt-1">Market: ${trade.market_id || 'N/A'}</p>
                            <p class="text-sm text-gray">Outcome: ${trade.outcome || 'N/A'}</p>
                            <p class="text-xs text-gray mt-1">${formatTimestamp(trade.opened_at)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray">Amount: $${(trade.amount || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray">Price: ${(trade.price || 0).toFixed(3)}</p>
                            ${trade.status === 'closed' ? `<p class="text-sm font-semibold ${colorClass}">P/L: $${profitLoss.toFixed(2)}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render target user activity item
        function renderTargetUserActivityItem(activity) {
            const price = activity.price || activity.priceFloat || 0;
            const size = activity.size || activity.outcomeTokensTraded || activity.shares || 0;
            const side = activity.side || activity.tradeType || 'N/A';
            const market = activity.market_name || activity.market || activity.conditionId || 'Market ID: ' + (activity.asset_id || 'Unknown');

            let timeStr = 'Unknown time';
            if (activity.timestamp) {
                const ts = typeof activity.timestamp === 'number' ? activity.timestamp * 1000 : activity.timestamp;
                timeStr = formatTimestamp(new Date(ts));
            } else if (activity.transactionTime) {
                timeStr = formatTimestamp(new Date(activity.transactionTime));
            }

            return `
                <div class="bot-list-item">
                    <div class="flex justify-between">
                        <span class="font-semibold text-sm text-white">${market}</span>
                        <span class="text-xs text-gray">${timeStr}</span>
                    </div>
                    <div class="text-sm text-gray mt-1">
                        <span class="font-medium ${side === 'BUY' || side === 'buy' ? 'text-green' : 'text-red'}">${side}</span>
                        • Price: $${parseFloat(price).toFixed(4)}
                        • Size: ${parseFloat(size).toFixed(2)}
                    </div>
                </div>
            `;
        }

        // Render section (preview or full)
        function renderSection(sectionName, isPreview) {
            const state = sectionStates[sectionName];
            const data = state.data || [];

            // Choose rendering function based on section type
            const renderItem = sectionName === 'targetUserActivity' ? renderTargetUserActivityItem : renderBotTradeItem;

            if (isPreview) {
                const previewEl = document.getElementById(sectionName + 'Preview');
                const previewData = data.slice(0, PREVIEW_ITEMS);

                if (previewData.length === 0) {
                    previewEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    previewEl.innerHTML = previewData.map(renderItem).join('');
                }
            } else {
                const listEl = document.getElementById(sectionName + 'List');
                const start = (state.page - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const pageData = data.slice(start, end);
                const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);

                if (pageData.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    listEl.innerHTML = pageData.map(renderItem).join('');
                }

                // Update pagination
                document.getElementById(sectionName + 'PageInfo').textContent = `Page ${state.page} of ${totalPages || 1}`;
                document.getElementById(sectionName + 'PrevBtn').disabled = state.page <= 1;
                document.getElementById(sectionName + 'NextBtn').disabled = state.page >= totalPages;
            }
        }

        // Load data for all sections
        async function loadSectionData() {
            try {
                // Load bot activity (all trades for this bot)
                const activityResponse = await fetch('/api/bots/' + botId + '/trades?limit=100');
                const activityData = await activityResponse.json();
                sectionStates.botActivity.data = activityData.trades || [];

                // Load target user activity
                let userAddress = botData.target_user_address;
                if (userAddress === null || userAddress === undefined) {
                    userAddress = extractUserAddress(botData.target_user_url);
                }

                if (userAddress) {
                    const targetResponse = await fetch('/api/user-activity/' + userAddress + '?limit=100');
                    const targetData = await targetResponse.json();
                    sectionStates.targetUserActivity.data = targetData.activities || [];
                } else {
                    sectionStates.targetUserActivity.data = [];
                }

                // Load open bets
                const openResponse = await fetch('/api/bots/' + botId + '/trades?status=open&limit=100');
                const openData = await openResponse.json();
                sectionStates.openBets.data = openData.trades || [];

                // Load closed bets
                const closedResponse = await fetch('/api/bots/' + botId + '/trades?status=closed&limit=100');
                const closedData = await closedResponse.json();
                sectionStates.closedBets.data = closedData.trades || [];

                // Render all sections
                Object.keys(sectionStates).forEach(sectionName => {
                    const state = sectionStates[sectionName];
                    renderSection(sectionName, !state.expanded);

                    // Apply saved expanded state
                    if (state.expanded) {
                        document.getElementById(sectionName + 'Preview').classList.add('hidden');
                        document.getElementById(sectionName + 'Expanded').classList.remove('hidden');
                        document.getElementById(sectionName + 'Arrow').classList.add('rotate-180');
                    }
                });

            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Initialize
        loadSectionStates();

        // Load data on page load
        loadBotData();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadBotData();
        }, 30000);
    </script>
</body>
</html>

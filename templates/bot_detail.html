<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Detail - BotForm2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header with Back Button -->
        <header class="mb-8">
            <div class="flex items-center gap-4 mb-4">
                <button onclick="window.location.href='/'" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    ← Back to Dashboard
                </button>
                <h1 id="botName" class="text-4xl font-bold text-gray-800">Loading...</h1>
            </div>
            <div class="flex gap-4 items-center">
                <span id="statusBadge" class="px-4 py-2 rounded-lg text-white font-semibold">Loading</span>
                <div id="healthCheck" class="text-sm"></div>
            </div>
        </header>

        <main>
            <!-- Control Buttons -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Bot Controls</h2>
                <div class="flex gap-4">
                    <button id="stopBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">
                        Stop
                    </button>
                    <button id="startPaperBtn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded">
                        Start (Paper)
                    </button>
                    <button id="startProdBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded">
                        Start (Production)
                    </button>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Performance</h2>
                    <div class="flex gap-2">
                        <button class="period-btn px-3 py-1 rounded border" data-period="1h">1H</button>
                        <button class="period-btn px-3 py-1 rounded border" data-period="24h">24H</button>
                        <button class="period-btn px-3 py-1 rounded border bg-blue-500 text-white" data-period="7d">7D</button>
                        <button class="period-btn px-3 py-1 rounded border" data-period="30d">30D</button>
                    </div>
                </div>
                <canvas id="performanceChart"></canvas>
            </div>

            <!-- Bot Recent Activity Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleSection('botActivity')">
                    <h2 class="text-xl font-semibold">Bot Recent Activity</h2>
                    <svg id="botActivityArrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="botActivityPreview" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">Loading bot activity...</p>
                </div>
                <div id="botActivityExpanded" class="hidden">
                    <div id="botActivityList" class="space-y-2 mb-4">
                        <!-- Activity items will be loaded here -->
                    </div>
                    <div id="botActivityPagination" class="flex justify-between items-center">
                        <button onclick="changePage('botActivity', -1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="botActivityPrevBtn">
                            ← Previous
                        </button>
                        <span id="botActivityPageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button onclick="changePage('botActivity', 1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="botActivityNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Open Bets Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleSection('openBets')">
                    <h2 class="text-xl font-semibold">Open Bets</h2>
                    <svg id="openBetsArrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="openBetsPreview" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">Loading open bets...</p>
                </div>
                <div id="openBetsExpanded" class="hidden">
                    <div id="openBetsList" class="space-y-2 mb-4">
                        <!-- Open bet items will be loaded here -->
                    </div>
                    <div id="openBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('openBets', -1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="openBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="openBetsPageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button onclick="changePage('openBets', 1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="openBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Closed Bets Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleSection('closedBets')">
                    <h2 class="text-xl font-semibold">Closed Bets</h2>
                    <svg id="closedBetsArrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="closedBetsPreview" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">Loading closed bets...</p>
                </div>
                <div id="closedBetsExpanded" class="hidden">
                    <div id="closedBetsList" class="space-y-2 mb-4">
                        <!-- Closed bet items will be loaded here -->
                    </div>
                    <div id="closedBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('closedBets', -1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="closedBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="closedBetsPageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button onclick="changePage('closedBets', 1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="closedBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Target User Recent Activity Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleSection('targetUserActivity')">
                    <h2 class="text-xl font-semibold">Target User Recent Activity</h2>
                    <svg id="targetUserActivityArrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="targetUserActivityPreview" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">Loading target user activity...</p>
                </div>
                <div id="targetUserActivityExpanded" class="hidden">
                    <div id="targetUserActivityList" class="space-y-2 mb-4">
                        <!-- Target user activity items will be loaded here -->
                    </div>
                    <div id="targetUserActivityPagination" class="flex justify-between items-center">
                        <button onclick="changePage('targetUserActivity', -1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="targetUserActivityPrevBtn">
                            ← Previous
                        </button>
                        <span id="targetUserActivityPageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button onclick="changePage('targetUserActivity', 1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded disabled:opacity-50" id="targetUserActivityNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bot Parameters -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Bot Parameters</h2>
                <form id="parametersForm" class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Max Trade Value ($)
                            <span class="text-gray-400 font-normal text-xs ml-1" title="Maximum amount per trade">(?)</span>
                        </label>
                        <input type="number" id="maxTradeValue" class="shadow border rounded w-full py-2 px-3" step="0.01">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Min Trade Value ($)
                            <span class="text-gray-400 font-normal text-xs ml-1" title="Minimum amount per trade">(?)</span>
                        </label>
                        <input type="number" id="minTradeValue" class="shadow border rounded w-full py-2 px-3" step="0.01">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Copy Ratio
                            <span class="text-gray-400 font-normal text-xs ml-1" title="Percentage of target trade size (0.0-1.0)">(?)</span>
                        </label>
                        <input type="number" id="copyRatio" class="shadow border rounded w-full py-2 px-3" step="0.01" min="0" max="1">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Stop Loss (%)
                            <span class="text-gray-400 font-normal text-xs ml-1" title="Percentage loss to trigger exit">(?)</span>
                        </label>
                        <input type="number" id="stopLoss" class="shadow border rounded w-full py-2 px-3" step="0.1">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Max Daily Loss ($)
                            <span class="text-gray-400 font-normal text-xs ml-1" title="Maximum total loss per day">(?)</span>
                        </label>
                        <input type="number" id="maxDailyLoss" class="shadow border rounded w-full py-2 px-3" step="0.01">
                    </div>
                    <div class="col-span-2 flex gap-2">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                            Update Parameters
                        </button>
                        <button type="button" id="resetParams" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">
                            Reset
                        </button>
                    </div>
                </form>
            </div>

            <!-- Notes Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Notes</h2>
                <textarea id="botNotes" class="shadow border rounded w-full py-2 px-3" rows="5" placeholder="Add notes about this bot..."></textarea>
                <p class="text-sm text-gray-500 mt-2">Auto-saves 2 seconds after you stop typing</p>
            </div>

            <!-- Danger Zone - Delete Bot -->
            <div class="bg-white rounded-lg shadow p-6 border-2 border-red-200">
                <h2 class="text-xl font-semibold mb-2 text-red-600">Danger Zone</h2>
                <p class="text-sm text-gray-600 mb-4">Deleting this bot is permanent and cannot be undone. All trade history and configuration will be lost.</p>
                <button id="deleteBotBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">
                    Delete Bot
                </button>
            </div>
        </main>
    </div>

    <script>
        const botId = window.location.pathname.split('/').pop();
        let botData = null;
        let notesDebounceTimer = null;
        let currentPeriod = '7d';

        // Initialize performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Profit/Loss ($)',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        // Load bot data
        async function loadBotData() {
            try {
                const response = await fetch('/api/bots/' + botId);
                if (response.ok === false) {
                    alert('Bot not found');
                    window.location.href = '/';
                    return;
                }

                botData = await response.json();

                // Update header
                document.getElementById('botName').textContent = botData.name;

                // Update status badge
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = botData.status.toUpperCase();
                if (botData.status === 'production') {
                    statusBadge.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-green-600';
                } else if (botData.status === 'paper') {
                    statusBadge.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-yellow-600';
                } else {
                    statusBadge.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-gray-600';
                }

                // Populate parameters form
                document.getElementById('maxTradeValue').value = botData.max_trade_value || 500;
                document.getElementById('minTradeValue').value = botData.min_trade_value || 50;
                document.getElementById('copyRatio').value = botData.copy_ratio || 0.5;
                document.getElementById('stopLoss').value = botData.stop_loss_percentage || 10;
                document.getElementById('maxDailyLoss').value = botData.max_daily_loss || 1000;

                // Populate notes
                document.getElementById('botNotes').value = botData.notes || '';

                // Load health check
                await checkTargetUserHealth();

                // Load section data
                await loadSectionData();

                // Load performance data
                await loadPerformanceData();

            } catch (error) {
                console.error('Error loading bot:', error);
                alert('Error loading bot data');
            }
        }

        // Check target user health
        async function checkTargetUserHealth() {
            const healthDiv = document.getElementById('healthCheck');
            healthDiv.innerHTML = '<span class="text-gray-500">Checking target user...</span>';

            try {
                const response = await fetch('/api/validate-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_user_url: botData.target_user_url})
                });

                const result = await response.json();

                if (result.valid === true) {
                    healthDiv.innerHTML = '<span class="text-green-600">✓ Target user: Active</span>';
                } else {
                    healthDiv.innerHTML = '<span class="text-red-600">✗ Target user: ' + result.message + '</span>';
                }
            } catch (error) {
                healthDiv.innerHTML = '<span class="text-red-600">✗ Health check failed</span>';
            }
        }

        // Extract user address from URL or direct input
        function extractUserAddress(targetUserUrl) {
            if (!targetUserUrl) return null;

            // Check if it's already a direct address (0x...)
            const directMatch = targetUserUrl.match(/^(0x[a-fA-F0-9]{40})$/);
            if (directMatch) {
                return directMatch[1];
            }

            // Try to extract from URL format
            const urlMatch = targetUserUrl.match(/\/user\/(0x[a-fA-F0-9]{40})/);
            if (urlMatch) {
                return urlMatch[1];
            }

            return null;
        }

        // Load performance data
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/bots/' + botId + '/performance?period=' + currentPeriod);
                const data = await response.json();

                if (data.data.length === 0) {
                    performanceChart.data.labels = [];
                    performanceChart.data.datasets[0].data = [];
                } else {
                    performanceChart.data.labels = data.data.map(d => new Date(d.timestamp).toLocaleString());
                    performanceChart.data.datasets[0].data = data.data.map(d => d.total_profit);
                }

                performanceChart.update();
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }

        // Period selectors
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                });
                this.classList.add('bg-blue-500', 'text-white');
                currentPeriod = this.dataset.period;
                loadPerformanceData();
            });
        });

        // Control buttons
        document.getElementById('stopBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/bots/' + botId + '/stop', {method: 'POST'});
                if (response.ok === true) {
                    alert('Bot stopped');
                    loadBotData();
                }
            } catch (error) {
                alert('Error stopping bot');
            }
        });

        document.getElementById('startPaperBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/bots/' + botId + '/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mode: 'paper'})
                });
                if (response.ok === true) {
                    alert('Bot started in paper mode');
                    loadBotData();
                }
            } catch (error) {
                alert('Error starting bot');
            }
        });

        document.getElementById('startProdBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to start in PRODUCTION mode? This will use real money.') === false) {
                return;
            }

            try {
                const response = await fetch('/api/bots/' + botId + '/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mode: 'production'})
                });
                if (response.ok === true) {
                    alert('Bot started in production mode');
                    loadBotData();
                }
            } catch (error) {
                alert('Error starting bot');
            }
        });

        // Update parameters
        document.getElementById('parametersForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const updateData = {
                max_trade_value: parseFloat(document.getElementById('maxTradeValue').value),
                min_trade_value: parseFloat(document.getElementById('minTradeValue').value),
                copy_ratio: parseFloat(document.getElementById('copyRatio').value),
                stop_loss_percentage: parseFloat(document.getElementById('stopLoss').value),
                max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value)
            };

            try {
                const response = await fetch('/api/bots/' + botId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updateData)
                });

                if (response.ok === true) {
                    alert('Parameters updated successfully');
                    loadBotData();
                } else {
                    alert('Failed to update parameters');
                }
            } catch (error) {
                alert('Error updating parameters');
            }
        });

        // Reset parameters
        document.getElementById('resetParams').addEventListener('click', () => {
            loadBotData();
        });

        // Auto-save notes with debounce
        document.getElementById('botNotes').addEventListener('input', () => {
            if (notesDebounceTimer !== null) {
                clearTimeout(notesDebounceTimer);
            }

            notesDebounceTimer = setTimeout(async () => {
                const notes = document.getElementById('botNotes').value;

                try {
                    await fetch('/api/bots/' + botId + '/notes', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({notes: notes})
                    });
                } catch (error) {
                    console.error('Error saving notes:', error);
                }
            }, 2000);
        });

        // Delete bot handler
        document.getElementById('deleteBotBtn').addEventListener('click', async () => {
            const botName = botData ? botData.name : 'this bot';
            const confirmMessage = 'Are you sure you want to delete "' + botName + '"?\n\nThis action cannot be undone. All trade history and configuration will be permanently lost.';

            if (confirm(confirmMessage) === false) {
                return;
            }

            // Double confirmation for extra safety
            if (confirm('This is your last chance. Really delete "' + botName + '"?') === false) {
                return;
            }

            try {
                const response = await fetch('/api/bots/' + botId, {
                    method: 'DELETE'
                });

                if (response.ok === true) {
                    alert('Bot deleted successfully');
                    window.location.href = '/';
                } else {
                    const errorData = await response.json();
                    alert('Failed to delete bot: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting bot: ' + error.message);
            }
        });

        // Section state management
        const sectionStates = {
            botActivity: { expanded: false, page: 1, data: [] },
            targetUserActivity: { expanded: false, page: 1, data: [] },
            openBets: { expanded: false, page: 1, data: [] },
            closedBets: { expanded: false, page: 1, data: [] }
        };

        const PREVIEW_ITEMS = 3;
        const ITEMS_PER_PAGE = 20;

        // Load section state from localStorage
        function loadSectionStates() {
            try {
                const saved = localStorage.getItem('botDetailSectionStates_' + botId);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.keys(sectionStates).forEach(key => {
                        if (parsed[key]) {
                            sectionStates[key].expanded = parsed[key].expanded || false;
                            sectionStates[key].page = parsed[key].page || 1;
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading section states:', e);
            }
        }

        // Save section states to localStorage
        function saveSectionStates() {
            try {
                const toSave = {};
                Object.keys(sectionStates).forEach(key => {
                    toSave[key] = {
                        expanded: sectionStates[key].expanded,
                        page: sectionStates[key].page
                    };
                });
                localStorage.setItem('botDetailSectionStates_' + botId, JSON.stringify(toSave));
            } catch (e) {
                console.error('Error saving section states:', e);
            }
        }

        // Toggle section expand/collapse
        function toggleSection(sectionName) {
            const state = sectionStates[sectionName];
            state.expanded = !state.expanded;

            const previewEl = document.getElementById(sectionName + 'Preview');
            const expandedEl = document.getElementById(sectionName + 'Expanded');
            const arrowEl = document.getElementById(sectionName + 'Arrow');

            if (state.expanded) {
                previewEl.classList.add('hidden');
                expandedEl.classList.remove('hidden');
                arrowEl.classList.add('rotate-180');
                renderSection(sectionName, false);
            } else {
                previewEl.classList.remove('hidden');
                expandedEl.classList.add('hidden');
                arrowEl.classList.remove('rotate-180');
                renderSection(sectionName, true);
            }

            saveSectionStates();
        }

        // Change page for a section
        function changePage(sectionName, direction) {
            const state = sectionStates[sectionName];
            const newPage = state.page + direction;
            const totalPages = Math.ceil(state.data.length / ITEMS_PER_PAGE);

            if (newPage < 1 || newPage > totalPages) return;

            state.page = newPage;
            renderSection(sectionName, false);
            saveSectionStates();
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);

            if (days > 0) return days + 'd ago';
            if (hours > 0) return hours + 'h ago';
            const minutes = Math.floor(diff / (1000 * 60));
            if (minutes > 0) return minutes + 'm ago';
            return 'Just now';
        }

        // Render bot trade item
        function renderBotTradeItem(trade) {
            const profitLoss = trade.profit_loss || 0;
            const isProfitable = profitLoss >= 0;
            const colorClass = isProfitable ? 'text-green-600' : 'text-red-600';

            return `
                <div class="border rounded p-3 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-xs bg-${trade.is_paper_trade ? 'blue' : 'green'}-100 text-${trade.is_paper_trade ? 'blue' : 'green'}-800 px-2 py-1 rounded">
                                    ${trade.is_paper_trade ? 'Paper' : 'Production'}
                                </span>
                                ${trade.status === 'open' ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Open</span>' : ''}
                                ${trade.status === 'closed' ? '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Closed</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Market: ${trade.market_id || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Outcome: ${trade.outcome || 'N/A'}</p>
                            <p class="text-xs text-gray-400 mt-1">${formatTimestamp(trade.opened_at)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Amount: $${(trade.amount || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-600">Price: ${(trade.price || 0).toFixed(3)}</p>
                            ${trade.status === 'closed' ? `<p class="text-sm font-semibold ${colorClass}">P/L: $${profitLoss.toFixed(2)}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render target user activity item
        function renderTargetUserActivityItem(activity) {
            const price = activity.price || activity.priceFloat || 0;
            const size = activity.size || activity.outcomeTokensTraded || activity.shares || 0;
            const side = activity.side || activity.tradeType || 'N/A';
            const market = activity.market_name || activity.market || activity.conditionId || 'Market ID: ' + (activity.asset_id || 'Unknown');

            let timeStr = 'Unknown time';
            if (activity.timestamp) {
                const ts = typeof activity.timestamp === 'number' ? activity.timestamp * 1000 : activity.timestamp;
                timeStr = formatTimestamp(new Date(ts));
            } else if (activity.transactionTime) {
                timeStr = formatTimestamp(new Date(activity.transactionTime));
            }

            return `
                <div class="border rounded p-3 hover:bg-gray-50">
                    <div class="flex justify-between">
                        <span class="font-semibold text-sm">${market}</span>
                        <span class="text-xs text-gray-500">${timeStr}</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <span class="font-medium ${side === 'BUY' || side === 'buy' ? 'text-green-600' : 'text-red-600'}">${side}</span>
                        • Price: $${parseFloat(price).toFixed(4)}
                        • Size: ${parseFloat(size).toFixed(2)}
                    </div>
                </div>
            `;
        }

        // Render section (preview or full)
        function renderSection(sectionName, isPreview) {
            const state = sectionStates[sectionName];
            const data = state.data || [];

            // Choose rendering function based on section type
            const renderItem = sectionName === 'targetUserActivity' ? renderTargetUserActivityItem : renderBotTradeItem;

            if (isPreview) {
                const previewEl = document.getElementById(sectionName + 'Preview');
                const previewData = data.slice(0, PREVIEW_ITEMS);

                if (previewData.length === 0) {
                    previewEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    previewEl.innerHTML = previewData.map(renderItem).join('');
                }
            } else {
                const listEl = document.getElementById(sectionName + 'List');
                const start = (state.page - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const pageData = data.slice(start, end);
                const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);

                if (pageData.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    listEl.innerHTML = pageData.map(renderItem).join('');
                }

                // Update pagination
                document.getElementById(sectionName + 'PageInfo').textContent = `Page ${state.page} of ${totalPages || 1}`;
                document.getElementById(sectionName + 'PrevBtn').disabled = state.page <= 1;
                document.getElementById(sectionName + 'NextBtn').disabled = state.page >= totalPages;
            }
        }

        // Load data for all sections
        async function loadSectionData() {
            try {
                // Load bot activity (all trades for this bot)
                const activityResponse = await fetch('/api/bots/' + botId + '/trades?limit=100');
                const activityData = await activityResponse.json();
                sectionStates.botActivity.data = activityData.trades || [];

                // Load target user activity
                let userAddress = botData.target_user_address;
                if (userAddress === null || userAddress === undefined) {
                    userAddress = extractUserAddress(botData.target_user_url);
                }

                if (userAddress) {
                    const targetResponse = await fetch('/api/user-activity/' + userAddress + '?limit=100');
                    const targetData = await targetResponse.json();
                    sectionStates.targetUserActivity.data = targetData.activities || [];
                } else {
                    sectionStates.targetUserActivity.data = [];
                }

                // Load open bets
                const openResponse = await fetch('/api/bots/' + botId + '/trades?status=open&limit=100');
                const openData = await openResponse.json();
                sectionStates.openBets.data = openData.trades || [];

                // Load closed bets
                const closedResponse = await fetch('/api/bots/' + botId + '/trades?status=closed&limit=100');
                const closedData = await closedResponse.json();
                sectionStates.closedBets.data = closedData.trades || [];

                // Render all sections
                Object.keys(sectionStates).forEach(sectionName => {
                    const state = sectionStates[sectionName];
                    renderSection(sectionName, !state.expanded);

                    // Apply saved expanded state
                    if (state.expanded) {
                        document.getElementById(sectionName + 'Preview').classList.add('hidden');
                        document.getElementById(sectionName + 'Expanded').classList.remove('hidden');
                        document.getElementById(sectionName + 'Arrow').classList.add('rotate-180');
                    }
                });

            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Initialize
        loadSectionStates();

        // Load data on page load
        loadBotData();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadBotData();
        }, 30000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotForm2 - Polymarket Copy Trading Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Jura', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Sticky Header -->
    <nav class="sticky top-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm border-b border-gray-800">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Left: Logo/Title -->
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-white">BotForm2</h1>
                </div>

                <!-- Center: Dashboard Stats -->
                <div class="hidden md:flex items-center space-x-6 text-sm">
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Total P/L</div>
                        <div id="headerPL" class="font-semibold text-green-400">$0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Win Rate</div>
                        <div id="headerWinRate" class="font-semibold text-white">0%</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Wallet Balance</div>
                        <div id="headerWallet" class="font-semibold text-yellow-400">$0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-xs">Active Bots</div>
                        <div id="headerActiveBots" class="font-semibold text-blue-400">0</div>
                    </div>
                </div>

                <!-- Right: User Menu -->
                <div class="flex items-center space-x-4">
                    <button id="hamburgerBtn" class="text-white hover:text-blue-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hamburger Menu (Hidden by default) -->
    <div id="hamburgerMenu" class="hidden fixed top-16 right-0 z-40 w-64 bg-black bg-opacity-90 border-l border-gray-800 shadow-xl">
        <div class="p-4 space-y-2">
            <a href="/" class="block px-4 py-2 text-white hover:bg-gray-700 rounded">Dashboard</a>
            {% if is_admin %}
            <a href="/settings" class="block px-4 py-2 text-white hover:bg-gray-700 rounded">Settings</a>
            {% endif %}
            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-red-400 hover:bg-gray-700 rounded">Logout</button>
        </div>
    </div>

    <!-- Video Background -->
    <div class="video-background">
        <video autoplay loop muted playsinline id="bgVideo">
            <source src="/bg.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Page Container -->
    <div class="page-container">
    <div class="container mx-auto px-4 py-8">
        <main>
            <!-- Performance Metrics Summary -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                <div class="metric-card">
                    <h3 class="metric-label">Wallet Balance</h3>
                    <p id="walletBalance" class="metric-value text-yellow">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="metric-label">Total P/L</h3>
                    <p id="totalPL" class="metric-value text-green">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="metric-label">Win Rate</h3>
                    <p id="winRate" class="metric-value text-white">0.0%</p>
                </div>
                <div class="metric-card">
                    <h3 class="metric-label">Total Bots</h3>
                    <p id="totalBots" class="metric-value text-white">0</p>
                </div>
                <div class="metric-card">
                    <h3 class="metric-label">Active Bots</h3>
                    <p id="activeBots" class="metric-value text-blue">0</p>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">Paper Trading Performance</h2>
                    <canvas id="paperChart"></canvas>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">Production Performance</h2>
                    <canvas id="productionChart"></canvas>
                </div>
            </div>

            <!-- Bot List -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">All Bots</h2>
                    <div class="flex gap-4">
                        {% if is_admin %}
                        <button id="newBotBtn" class="btn btn-primary">
                            + New Bot
                        </button>
                        {% endif %}
                        <select id="filterStatus" class="border rounded px-3 py-1">
                            <option value="">All Status</option>
                            <option value="inactive">Inactive</option>
                            <option value="paper">Paper</option>
                            <option value="production">Production</option>
                        </select>
                        <select id="sortBy" class="border rounded px-3 py-1">
                            <option value="created_at">Created Date</option>
                            <option value="name">Name</option>
                            <option value="total_profit">Profit (High-Low)</option>
                        </select>
                    </div>
                </div>

                <div id="botList" class="space-y-2">
                    <p class="text-gray text-center py-8">No bots yet. Create your first bot to get started!</p>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('recentActivity')">
                    <h2 class="text-xl font-semibold text-white">Recent Activity</h2>
                    <svg id="recentActivityArrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="recentActivityPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading recent activity...</p>
                </div>
                <div id="recentActivityExpanded" class="hidden">
                    <div id="recentActivityList" class="space-y-2 mb-4">
                        <!-- Activity items will be loaded here -->
                    </div>
                    <div id="recentActivityPagination" class="flex justify-between items-center">
                        <button onclick="changePage('recentActivity', -1)" class="btn btn-secondary disabled:opacity-50" id="recentActivityPrevBtn">
                            ← Previous
                        </button>
                        <span id="recentActivityPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('recentActivity', 1)" class="btn btn-secondary disabled:opacity-50" id="recentActivityNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Open Bets Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('openBets')">
                    <h2 class="text-xl font-semibold text-white">Open Bets</h2>
                    <svg id="openBetsArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="openBetsPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading open bets...</p>
                </div>
                <div id="openBetsExpanded" class="hidden">
                    <div id="openBetsList" class="space-y-2 mb-4">
                        <!-- Open bet items will be loaded here -->
                    </div>
                    <div id="openBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('openBets', -1)" class="btn btn-secondary disabled:opacity-50" id="openBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="openBetsPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('openBets', 1)" class="btn btn-secondary disabled:opacity-50" id="openBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Closed Bets Section -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer section-header" onclick="toggleSection('closedBets')">
                    <h2 class="text-xl font-semibold text-white">Closed Bets</h2>
                    <svg id="closedBetsArrow" class="w-6 h-6 transform transition-transform section-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="closedBetsPreview" class="space-y-2">
                    <p class="text-gray text-center py-4">Loading closed bets...</p>
                </div>
                <div id="closedBetsExpanded" class="hidden">
                    <div id="closedBetsList" class="space-y-2 mb-4">
                        <!-- Closed bet items will be loaded here -->
                    </div>
                    <div id="closedBetsPagination" class="flex justify-between items-center">
                        <button onclick="changePage('closedBets', -1)" class="btn btn-secondary disabled:opacity-50" id="closedBetsPrevBtn">
                            ← Previous
                        </button>
                        <span id="closedBetsPageInfo" class="text-sm text-gray">Page 1</span>
                        <button onclick="changePage('closedBets', 1)" class="btn btn-secondary disabled:opacity-50" id="closedBetsNextBtn">
                            Next →
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Bot Modal (Complete) -->
    <div id="createBotModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="modal-content p-8 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">Create New Bot</h2>
            <form id="createBotForm">
                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">
                        Bot Name
                        <span class="text-gray font-normal text-xs ml-1" title="A friendly name to identify your bot">(?)</span>
                    </label>
                    <input type="text" id="botName" class="w-full py-2 px-3" required>
                </div>

                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">
                        Target User Address or URL
                        <span class="text-gray font-normal text-xs ml-1" title="Ethereum address (0x...) or Polymarket profile URL">(?)</span>
                    </label>
                    <input type="text" id="targetUrl" class="w-full py-2 px-3" placeholder="0xa20b482f97063f4f88ef621c9203e60814399940 or https://polymarket.com/user/0x..." required>
                    <p id="validationMessage" class="text-sm mt-1 hidden"></p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white text-sm font-bold mb-2">
                            Max Trade Value ($)
                            <span class="text-gray font-normal text-xs ml-1" title="Maximum amount per trade in dollars">(?)</span>
                        </label>
                        <input type="number" id="maxTradeValue" class="w-full py-2 px-3" value="500" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-white text-sm font-bold mb-2">
                            Min Trade Value ($)
                            <span class="text-gray font-normal text-xs ml-1" title="Minimum amount per trade in dollars">(?)</span>
                        </label>
                        <input type="number" id="minTradeValue" class="w-full py-2 px-3" value="50" min="0" step="0.01" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-white text-sm font-bold mb-2">
                            Copy Ratio
                            <span class="text-gray font-normal text-xs ml-1" title="Percentage of target user's trade size to copy (0.0-1.0)">(?)</span>
                        </label>
                        <input type="number" id="copyRatio" class="w-full py-2 px-3" value="0.5" min="0" max="1" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-white text-sm font-bold mb-2">
                            Stop Loss (%)
                            <span class="text-gray font-normal text-xs ml-1" title="Percentage loss to trigger automatic exit">(?)</span>
                        </label>
                        <input type="number" id="stopLoss" class="w-full py-2 px-3" value="10" min="0" max="100" step="0.1" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">
                        Max Daily Loss ($)
                        <span class="text-gray font-normal text-xs ml-1" title="Maximum total loss allowed per day before bot stops">(?)</span>
                    </label>
                    <input type="number" id="maxDailyLoss" class="w-full py-2 px-3" value="1000" min="0" step="0.01" required>
                </div>

                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">
                        Notes (Optional)
                        <span class="text-gray font-normal text-xs ml-1" title="Any notes or observations about this bot">(?)</span>
                    </label>
                    <textarea id="botNotes" class="w-full py-2 px-3" rows="3"></textarea>
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="createBotBtn" class="btn btn-primary flex-1">
                        Create
                    </button>
                    <button type="button" id="cancelBtn" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    </div>

    <script>
        // Lazy load video background
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('bgVideo');
            if (video && video.getAttribute('src') === null) {
                const source = video.querySelector('source');
                if (source) {
                    video.load();
                }
            }
        });

        // Admin status from Jinja template
        const isAdmin = {{ is_admin|tojson }};

        // Hamburger menu toggle
        document.getElementById('hamburgerBtn').addEventListener('click', () => {
            const menu = document.getElementById('hamburgerMenu');
            menu.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('hamburgerMenu');
            const btn = document.getElementById('hamburgerBtn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Logout function
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => window.location.href = '/login');
        }

        // Update header stats
        function updateHeaderStats() {
            const totalPL = document.getElementById('totalPL').textContent;
            const winRate = document.getElementById('winRate').textContent;
            const wallet = document.getElementById('walletBalance').textContent;
            const activeBots = document.getElementById('activeBots').textContent;

            document.getElementById('headerPL').textContent = totalPL;
            document.getElementById('headerPL').className = 'font-semibold ' +
                (parseFloat(totalPL.replace('$', '').replace(',', '')) >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('headerWinRate').textContent = winRate;
            document.getElementById('headerWallet').textContent = wallet;
            document.getElementById('headerActiveBots').textContent = activeBots;
        }

        // Initialize charts
        const paperCtx = document.getElementById('paperChart').getContext('2d');
        const productionCtx = document.getElementById('productionChart').getContext('2d');

        const chartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Profit/Loss',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgb(255, 255, 255)'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgb(156, 163, 175)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: 'rgb(156, 163, 175)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        };

        const paperChart = new Chart(paperCtx, chartConfig);
        const productionChart = new Chart(productionCtx, chartConfig);

        // Load bots
        async function loadBots() {
            try {
                const response = await fetch('/api/bots');
                const data = await response.json();
                const bots = data.bots || [];

                // Calculate aggregate metrics
                const totalWalletBalance = bots.reduce((sum, bot) => sum + (bot.paper_wallet_balance || 0), 0);
                const totalProfit = bots.reduce((sum, bot) => sum + (bot.total_profit || 0), 0);
                const totalLoss = bots.reduce((sum, bot) => sum + (bot.total_loss || 0), 0);
                const netPL = totalProfit - totalLoss;
                const totalTrades = bots.reduce((sum, bot) => sum + (bot.total_trades || 0), 0);
                const totalWinningTrades = bots.reduce((sum, bot) => sum + (bot.winning_trades || 0), 0);
                const winRate = totalTrades > 0 ? (totalWinningTrades / totalTrades * 100) : 0;

                // Update metrics
                document.getElementById('walletBalance').textContent = `$${totalWalletBalance.toFixed(2)}`;
                document.getElementById('totalPL').textContent = `$${netPL.toFixed(2)}`;
                document.getElementById('totalPL').className = `metric-value ${netPL >= 0 ? 'text-green' : 'text-red'}`;
                document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
                document.getElementById('totalBots').textContent = bots.length;
                const activeBots = bots.filter(b => b.status !== 'inactive');
                document.getElementById('activeBots').textContent = activeBots.length;

                // Update header stats
                updateHeaderStats();

                // Update bot list
                const botList = document.getElementById('botList');
                if (bots.length === 0) {
                    botList.innerHTML = '<p class="text-gray text-center py-8">No bots yet. Create your first bot to get started!</p>';
                } else {
                    botList.innerHTML = bots.map(bot => `
                        <div class="bot-list-item flex justify-between items-center" onclick="window.location.href='/bot/${bot.bot_id}'">
                            <div>
                                <h3 class="font-semibold text-white">${bot.name}</h3>
                                <div class="flex gap-2 mt-1">
                                    <span class="badge badge-${bot.status}">${bot.status.toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold ${(bot.total_profit || 0) >= 0 ? 'text-green' : 'text-red'}">
                                    $${(bot.total_profit || 0).toFixed(2)}
                                </p>
                                <p class="text-sm text-gray">${bot.total_trades || 0} trades</p>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        // Modal controls
        const newBotBtn = document.getElementById('newBotBtn');
        if (newBotBtn) {
            newBotBtn.addEventListener('click', () => {
                if (!isAdmin) {
                    alert('Guest users cannot create bots. Please log in as admin.');
                    return;
                }
                document.getElementById('createBotModal').classList.remove('hidden');
            });
        }

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('createBotModal').classList.add('hidden');
        });

        // Create bot form
        document.getElementById('createBotForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAdmin) {
                alert('Guest users cannot create bots. Please log in as admin.');
                return;
            }

            const createBtn = document.getElementById('createBotBtn');
            const validationMsg = document.getElementById('validationMessage');
            const targetUrl = document.getElementById('targetUrl').value;

            // Disable button and show loading state
            createBtn.disabled = true;
            createBtn.textContent = 'Validating...';
            validationMsg.classList.add('hidden');

            try {
                // Step 1: Validate user address
                const validationResponse = await fetch('/api/validate-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_user_url: targetUrl})
                });

                const validationResult = await validationResponse.json();

                if (validationResult.valid === false) {
                    // Validation failed
                    validationMsg.textContent = validationResult.message || 'Invalid user URL or user not found on Polymarket';
                    validationMsg.classList.remove('hidden');
                    validationMsg.classList.add('text-red-600');
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create';
                    return;
                }

                // Validation passed, show success
                validationMsg.textContent = 'User validated successfully!';
                validationMsg.classList.remove('hidden', 'text-red-600');
                validationMsg.classList.add('text-green-600');

                // Step 2: Create bot with all parameters
                createBtn.textContent = 'Creating...';

                const botData = {
                    name: document.getElementById('botName').value,
                    bot_type: 'copy',
                    target_user_url: targetUrl,
                    max_trade_value: parseFloat(document.getElementById('maxTradeValue').value),
                    min_trade_value: parseFloat(document.getElementById('minTradeValue').value),
                    copy_ratio: parseFloat(document.getElementById('copyRatio').value),
                    stop_loss_percentage: parseFloat(document.getElementById('stopLoss').value),
                    max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value),
                    notes: document.getElementById('botNotes').value
                };

                const createResponse = await fetch('/api/bots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(botData)
                });

                if (createResponse.ok === true) {
                    const createdBot = await createResponse.json();

                    // Close modal and reset form
                    document.getElementById('createBotModal').classList.add('hidden');
                    document.getElementById('createBotForm').reset();
                    validationMsg.classList.add('hidden');

                    // Redirect to bot detail page
                    window.location.href = '/bot/' + createdBot.bot_id;
                } else {
                    const errorData = await createResponse.json();
                    alert('Failed to create bot: ' + (errorData.detail || 'Unknown error'));
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create';
                }
            } catch (error) {
                console.error('Error creating bot:', error);
                validationMsg.textContent = 'Error: ' + error.message;
                validationMsg.classList.remove('hidden', 'text-green-600');
                validationMsg.classList.add('text-red-600');
                createBtn.disabled = false;
                createBtn.textContent = 'Create';
            }
        });

        // Section state management
        const sectionStates = {
            recentActivity: { expanded: false, page: 1, data: [] },
            openBets: { expanded: false, page: 1, data: [] },
            closedBets: { expanded: false, page: 1, data: [] }
        };

        const PREVIEW_ITEMS = 3;
        const ITEMS_PER_PAGE = 20;

        // Load section state from localStorage
        function loadSectionStates() {
            try {
                const saved = localStorage.getItem('homepageSectionStates');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.keys(sectionStates).forEach(key => {
                        if (parsed[key]) {
                            sectionStates[key].expanded = parsed[key].expanded || false;
                            sectionStates[key].page = parsed[key].page || 1;
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading section states:', e);
            }
        }

        // Save section states to localStorage
        function saveSectionStates() {
            try {
                const toSave = {};
                Object.keys(sectionStates).forEach(key => {
                    toSave[key] = {
                        expanded: sectionStates[key].expanded,
                        page: sectionStates[key].page
                    };
                });
                localStorage.setItem('homepageSectionStates', JSON.stringify(toSave));
            } catch (e) {
                console.error('Error saving section states:', e);
            }
        }

        // Toggle section expand/collapse
        function toggleSection(sectionName) {
            const state = sectionStates[sectionName];
            state.expanded = !state.expanded;

            const previewEl = document.getElementById(sectionName + 'Preview');
            const expandedEl = document.getElementById(sectionName + 'Expanded');
            const arrowEl = document.getElementById(sectionName + 'Arrow');

            if (state.expanded) {
                previewEl.classList.add('hidden');
                expandedEl.classList.remove('hidden');
                arrowEl.classList.add('rotate-180');
                renderSection(sectionName, false);
            } else {
                previewEl.classList.remove('hidden');
                expandedEl.classList.add('hidden');
                arrowEl.classList.remove('rotate-180');
                renderSection(sectionName, true);
            }

            saveSectionStates();
        }

        // Change page for a section
        function changePage(sectionName, direction) {
            const state = sectionStates[sectionName];
            const newPage = state.page + direction;
            const totalPages = Math.ceil(state.data.length / ITEMS_PER_PAGE);

            if (newPage < 1 || newPage > totalPages) return;

            state.page = newPage;
            renderSection(sectionName, false);
            saveSectionStates();
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);

            if (days > 0) return days + 'd ago';
            if (hours > 0) return hours + 'h ago';
            const minutes = Math.floor(diff / (1000 * 60));
            if (minutes > 0) return minutes + 'm ago';
            return 'Just now';
        }

        // Render trade item
        function renderTradeItem(trade) {
            const profitLoss = trade.profit_loss || 0;
            const isProfitable = profitLoss >= 0;
            const colorClass = isProfitable ? 'text-green' : 'text-red';

            return `
                <div class="bot-list-item">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-white">${trade.bot_name || 'Unknown Bot'}</span>
                                <span class="badge badge-${trade.is_paper_trade ? 'paper' : 'production'}">
                                    ${trade.is_paper_trade ? 'Paper' : 'Production'}
                                </span>
                                ${trade.status === 'open' ? '<span class="badge badge-open">Open</span>' : ''}
                                ${trade.status === 'closed' ? '<span class="badge badge-closed">Closed</span>' : ''}
                            </div>
                            <p class="text-sm text-gray mt-1">Market: ${trade.market_id || 'N/A'}</p>
                            <p class="text-sm text-gray">Outcome: ${trade.outcome || 'N/A'}</p>
                            <p class="text-xs text-gray mt-1">${formatTimestamp(trade.opened_at)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray">Amount: $${(trade.amount || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray">Price: ${(trade.price || 0).toFixed(3)}</p>
                            ${trade.status === 'closed' ? `<p class="text-sm font-semibold ${colorClass}">P/L: $${profitLoss.toFixed(2)}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render section (preview or full)
        function renderSection(sectionName, isPreview) {
            const state = sectionStates[sectionName];
            const data = state.data || [];

            if (isPreview) {
                const previewEl = document.getElementById(sectionName + 'Preview');
                const previewData = data.slice(0, PREVIEW_ITEMS);

                if (previewData.length === 0) {
                    previewEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    previewEl.innerHTML = previewData.map(renderTradeItem).join('');
                }
            } else {
                const listEl = document.getElementById(sectionName + 'List');
                const start = (state.page - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const pageData = data.slice(start, end);
                const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);

                if (pageData.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                } else {
                    listEl.innerHTML = pageData.map(renderTradeItem).join('');
                }

                // Update pagination
                document.getElementById(sectionName + 'PageInfo').textContent = `Page ${state.page} of ${totalPages || 1}`;
                document.getElementById(sectionName + 'PrevBtn').disabled = state.page <= 1;
                document.getElementById(sectionName + 'NextBtn').disabled = state.page >= totalPages;
            }
        }

        // Load data for all sections
        async function loadSectionData() {
            try {
                // Load recent activity (all trades)
                const activityResponse = await fetch('/api/trades/all?limit=100');
                const activityData = await activityResponse.json();
                sectionStates.recentActivity.data = activityData.trades || [];

                // Load open bets
                const openResponse = await fetch('/api/trades/all?status=open&limit=100');
                const openData = await openResponse.json();
                sectionStates.openBets.data = openData.trades || [];

                // Load closed bets
                const closedResponse = await fetch('/api/trades/all?status=closed&limit=100');
                const closedData = await closedResponse.json();
                sectionStates.closedBets.data = closedData.trades || [];

                // Render all sections
                Object.keys(sectionStates).forEach(sectionName => {
                    const state = sectionStates[sectionName];
                    renderSection(sectionName, !state.expanded);

                    // Apply saved expanded state
                    if (state.expanded) {
                        document.getElementById(sectionName + 'Preview').classList.add('hidden');
                        document.getElementById(sectionName + 'Expanded').classList.remove('hidden');
                        document.getElementById(sectionName + 'Arrow').classList.add('rotate-180');
                    }
                });

            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Initialize
        loadSectionStates();

        // Load on page load
        loadBots();
        loadSectionData();

        // Auto-refresh every 30 seconds
        setInterval(loadBots, 30000);
        setInterval(loadSectionData, 30000);
    </script>
</body>
</html>
